{% extends "base.html" %}
{% block title %}{{ project.title }} - CapstoneGuard{% endblock %}

{% block content %}
<div style="max-width:1100px;margin:0 auto;padding:2rem 1.5rem;">
    <div style="display:grid;grid-template-columns:1fr 300px;gap:1.2rem;align-items:start;">

        <!-- MAIN COLUMN -->
        <div>
            <!-- Project Header Card -->
            <div class="oc-card" style="margin-bottom:1.2rem;">
                <div class="oc-card-body">
                    <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:1rem;flex-wrap:wrap;margin-bottom:1rem;">
                        <div>
                            <h1 style="font-family:'DM Serif Display',serif;font-size:1.7rem;color:var(--text-dark);letter-spacing:-0.03em;margin-bottom:0.5rem;">{{ project.title }}</h1>
                            <div style="display:flex;align-items:center;gap:0.8rem;flex-wrap:wrap;font-size:0.82rem;color:var(--text-muted);">
                                <span><i class="bi bi-person"></i> {{ project.author.full_name }}</span>
                                <span><i class="bi bi-calendar"></i> {{ project.submitted_at.strftime('%B %d, %Y') }}</span>
                                <span><i class="bi bi-folder"></i> {{ project.stream.name }}</span>
                            </div>
                        </div>
                        <span class="oc-badge badge-{{ project.status.value }}" style="font-size:0.82rem;padding:0.3rem 0.85rem;">{{ project.status.value|title }}</span>
                    </div>

                    {% if can_edit %}
                    <div style="margin-bottom:1rem;">
                        <a href="{{ url_for('projects.edit_project', project_id=project.id) }}" class="btn-oc btn-oc-outline btn-oc-sm">
                            <i class="bi bi-pencil"></i> Edit Project
                        </a>
                    </div>
                    {% endif %}

                    <div class="oc-section">
                        <div style="font-size:0.75rem;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:0.6rem;">Description</div>
                        <p style="font-size:0.92rem;color:var(--text-muted);line-height:1.75;white-space:pre-wrap;">{{ project.description }}</p>
                    </div>

                    {% if project.technologies %}
                    <div class="oc-section">
                        <div style="font-size:0.75rem;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:0.6rem;">Technologies</div>
                        <div style="display:flex;flex-wrap:wrap;gap:0.5rem;">
                            {% for tech in project.technologies.split(',') %}
                            <span class="tech-tag">{{ tech.strip() }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    {% if project.github_url or project.demo_url %}
                    <div class="oc-section">
                        <div style="font-size:0.75rem;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:0.6rem;">Links</div>
                        <div style="display:flex;gap:0.6rem;flex-wrap:wrap;">
                            {% if project.github_url %}
                            <a href="{{ project.github_url }}" target="_blank" class="btn-oc btn-oc-outline btn-oc-sm">
                                <i class="bi bi-github"></i> Repository
                            </a>
                            {% endif %}
                            {% if project.demo_url %}
                            <a href="{{ project.demo_url }}" target="_blank" class="btn-oc btn-oc-primary btn-oc-sm">
                                <i class="bi bi-link-45deg"></i> Live Demo
                            </a>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Similar Projects Warning -->
            {% if similar_projects %}
            <div class="warning-box" style="margin-bottom:1.2rem;">
                <div class="warning-box-header">
                    <i class="bi bi-exclamation-triangle-fill"></i>
                    {{ similar_projects|length }} Similar Project(s) Found
                </div>
                <div class="warning-box-body">
                    <p style="font-size:0.88rem;color:var(--text-muted);margin-bottom:1rem;">
                        Please review similar projects to ensure your submission offers something unique.
                    </p>
                    {% for similar in similar_projects %}
                    <div class="oc-card" style="margin-bottom:0.75rem;">
                        <div class="oc-card-body" style="padding:1rem 1.2rem;">
                            <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:0.75rem;margin-bottom:0.4rem;">
                                <h6 style="font-weight:700;font-size:0.9rem;margin:0;">
                                    <a href="{{ url_for('projects.project_detail', project_id=similar.project.id) }}" style="color:var(--text-dark);text-decoration:none;">{{ similar.project.title }}</a>
                                </h6>
                                <div style="display:flex;gap:0.4rem;flex-shrink:0;">
                                    <span class="oc-badge badge-info">T: {{ similar.title_similarity }}%</span>
                                    <span class="oc-badge badge-info">D: {{ similar.description_similarity }}%</span>
                                </div>
                            </div>
                            <p style="font-size:0.82rem;color:var(--text-muted);margin-bottom:0.3rem;">{{ similar.project.description[:150] }}…</p>
                            <small style="font-size:0.75rem;color:var(--text-muted);">
                                by {{ similar.project.author.full_name }} · {{ similar.project.stream.name }}
                            </small>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Comments -->
            <div class="oc-card">
                <div class="oc-card-header">
                    <h2 class="oc-card-title">Comments ({{ comments|length }})</h2>
                </div>
                <div class="oc-card-body">
                    <!-- Post comment -->
                    <form method="POST" action="{{ url_for('projects.add_comment', project_id=project.id) }}" style="margin-bottom:1.5rem;">
                        <label class="oc-label">Add a comment</label>
                        <textarea class="oc-textarea" name="content" rows="3" required placeholder="Share your thoughts…" style="margin-bottom:0.6rem;"></textarea>
                        <button type="submit" class="btn-oc btn-oc-primary btn-oc-sm">Post Comment</button>
                    </form>

                    {% if comments %}
                        {% for comment in comments %}
                        <div class="comment-item">
                            <div class="avatar-circle">{{ comment.author.full_name[0].upper() }}</div>
                            <div style="flex:1;min-width:0;">
                                <div style="display:flex;justify-content:space-between;align-items:baseline;gap:0.5rem;margin-bottom:0.25rem;">
                                    <span style="font-weight:600;font-size:0.88rem;">{{ comment.author.full_name }}</span>
                                    <span style="font-size:0.75rem;color:var(--text-muted);">{{ comment.created_at|timeago }}</span>
                                </div>
                                <p style="font-size:0.88rem;color:var(--text-muted);margin:0;line-height:1.6;">{{ comment.content }}</p>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-state" style="padding:2rem;">
                            <p class="empty-text">No comments yet. Be the first to comment!</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- SIDEBAR -->
        <div>
            <!-- Status Update (admin/reviewer) -->
            {% if session.user_role in ['admin', 'reviewer'] %}
            <div class="oc-card" style="margin-bottom:1rem;">
                <div class="oc-card-header"><h2 class="oc-card-title">Update Status</h2></div>
                <div class="oc-card-body">
                    <form method="POST" action="{{ url_for('projects.update_project_status', project_id=project.id) }}">
                        <div class="field">
                            <label class="oc-label">Status</label>
                            <select class="oc-select" name="status" required>
                                {% for s in ['pending','under_review','approved','rejected'] %}
                                <option value="{{ s }}" {% if project.status.value == s %}selected{% endif %}>{{ s|replace('_',' ')|title }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="field" style="margin-top:0.9rem;">
                            <label class="oc-label">Review Notes</label>
                            <textarea class="oc-textarea" name="review_notes" rows="3">{{ project.review_notes or '' }}</textarea>
                        </div>
                        <button type="submit" class="btn-oc btn-oc-primary" style="width:100%;justify-content:center;margin-top:0.9rem;">Update Status</button>
                    </form>
                </div>
            </div>
            {% endif %}

            <!-- Project Info -->
            <div class="oc-card">
                <div class="oc-card-header"><h2 class="oc-card-title">Project Info</h2></div>
                <div class="oc-card-body">
                    {% for label, value in [
                        ('Submitted', project.submitted_at.strftime('%B %d, %Y')),
                        ('Last Updated', project.updated_at|timeago),
                        ('Stream', project.stream.name)
                    ] %}
                    <div style="margin-bottom:0.9rem;">
                        <div style="font-size:0.72rem;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:0.2rem;">{{ label }}</div>
                        <div style="font-weight:600;font-size:0.9rem;color:var(--text-dark);">{{ value }}</div>
                    </div>
                    {% endfor %}
                    {% if project.reviewer %}
                    <div>
                        <div style="font-size:0.72rem;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:0.2rem;">Reviewed By</div>
                        <div style="font-weight:600;font-size:0.9rem;color:var(--text-dark);">{{ project.reviewer.full_name }}</div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

    </div>
</div>

<style>
@media(max-width:900px){
    div[style*="grid-template-columns:1fr 300px"]{grid-template-columns:1fr !important;}
}
</style>
{% endblock %}
